name: CD - Deploy to DEV

on:
  workflow_run:
    workflows: ["CI - DEV"]
    types:
      - completed

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Create kubeconfig (PowerShell â€“ SAFE)
        shell: powershell
        env:
          DEV_KUBECONFIG_B64: ${{ secrets.DEV_KUBECONFIG_B64 }}
        run: |
          $content = $env:DEV_KUBECONFIG_B64
          [System.IO.File]::WriteAllText("kubeconfig.b64", $content)
          certutil -decode kubeconfig.b64 kubeconfig.yaml

      - name: Export kubeconfig
        shell: powershell
        run: |
          "KUBECONFIG=$PWD\kubeconfig.yaml" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Verify cluster access
        shell: powershell
        run: kubectl get ns

      - name: Deploy backend
        shell: powershell
        run: |
          kubectl apply -f k8s/dev/backend-deployment.yaml
          kubectl apply -f k8s/dev/backend-service.yaml

      - name: Deploy frontend
        shell: powershell
        run: |
          kubectl apply -f k8s/dev/frontend-configmap.yaml
          kubectl apply -f k8s/dev/frontend-deployment.yaml
          kubectl apply -f k8s/dev/frontend-service.yaml
          kubectl apply -f k8s/dev/frontend-ingress.yaml